<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Photo Booth ðŸ“¸</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Playfair+Display:wght@700&family=Caveat:wght@700&display=swap" rel="stylesheet">

<style>

body {
  opacity: 0;
  animation: fadeZoomGlow 1.5s ease forwards;
}

@keyframes fadeZoomGlow {
  0% {
    opacity: 0;
    transform: scale(0.97);
    box-shadow: 0 0 0px rgba(255, 200, 255, 0);
  }
  50% {
    opacity: 0.6;
    transform: scale(1.02);
    box-shadow: 0 0 40px rgba(255, 200, 255, 0.3);
  }
  100% {
    opacity: 1;
    transform: scale(1);
    box-shadow: 0 0 20px rgba(255, 200, 255, 0.2);
  }
}

:root{
  --bg1: radial-gradient(circle, #f9f4fc 0%, #e6d4f0 60%, #d4b2e8 100%);
  --accent: #a259c1;
  --card-bg: rgba(255, 255, 255, 0.6);
  --text-color: #4a2f5a;
  --muted: #7a607e;
  --shadow: 0 18px 50px rgba(44, 31, 62, 0.12);
  --glass-blur: 10px;
  font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
}

body {
  height:100%;
  margin:0;
  background: var(--bg1);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:2rem;
  box-sizing: border-box;
  text-align: center;
  overflow: hidden;
}

html {
  height: 100%;
  overflow: hidden;
}

.back-btn{
  position: fixed;
  top: 20px;
  left: 20px;
  color: #4a2f5a;
  cursor: pointer;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.521);
  border: none;
  padding: 8px 14px;
  border-radius: 20px;
  transition: background 0.2s ease;
  z-index: 1000;
}
.back-btn:hover {
  background: rgba(255, 255, 255, 0.795);
}

/* --------------------------------------------------
   Main App Box â€” FIXED RESPONSIVE
-------------------------------------------------- */
.app {
  width: 100%;
  max-width: 980px;
  margin: 0 auto; /* Remove vertical margins to allow flex centering */
  border-radius: 20px;

  background: linear-gradient(180deg, rgba(255,255,255,0.84), rgba(255,255,255,0.7));
  box-shadow: var(--shadow);

  padding: 0 20px; /* Adjust padding to work with new structure */
  box-sizing: border-box;

  display: flex; /* Change to flex to manage internal scrolling */
  flex-direction: column;
  max-height: 95vh; /* Ensure app container fits on screen */
  backdrop-filter: blur(var(--glass-blur));
  margin-right: 10px;
}

.app-content {
  display: flex; /* Changed to flex for better height management */
  grid-template-columns: 1fr 200px;
  gap: 18px;
  align-items: stretch; /* Make both columns equal height */
  padding: 15px 0; /* Reduced vertical padding */
  overflow-y: hidden; /* Ensure no scrolling occurs */
  min-height: 0; /* Fix for flexbox shrinking issues */
}

/* --------------------------------------------------
   Camera
-------------------------------------------------- */
.camera-shell { 
  display:flex; 
  flex-direction:column; 
  gap:12px; 
  align-items:center; 
  justify-content:flex-start;
  flex: 1; /* Allow camera shell to take up space */
  min-width: 0; /* Fix for flexbox shrinking issues */
}
.camera-frame { 
  width:100%; 
  max-width:640px; 

  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,248,252,0.94)); 
  border-radius: 18px; 
  padding: 14px; 
  border: 1px solid rgba(74,47,90,0.06); 
  box-shadow: 0 12px 30px rgba(44,31,62,0.06); 

  display:flex; 
  flex-direction:column; 
  gap:12px; 
  position: relative; /* For positioning the cam status chip */
  align-items:center; 
  padding-bottom: 20px; 
}

.viewer { 
  width: 100%; 
  border-radius: 12px; 
  overflow:hidden; 
  background: #000; 
  position:relative; 
  border: 9px solid rgba(255,255,255,0.85); 
  box-shadow: 0 8px 28px rgba(74,47,90,0.06); 
}

video { 
  width:100%; 
  height:100%; 
  max-height:480px; 
  object-fit:cover; 
  transform: scaleX(-1); 
  display:block; 
}

.chip {
  background:rgba(255,255,255,0.92); 
  padding:6px 8px; 
  border-radius:10px; 
  font-size:0.85rem; 
  color:var(--muted); 
  border:1px solid rgba(74,47,90,0.03);
}
#camStatus {
  position: absolute;
  top: 14px;
  right: 14px;
  z-index: 10;
}

/* Countdown */
.countdown {
  position:absolute;
  top: 50%;
  left: 50%;
  width: 100px;
  height: 100px;
  border-radius: 24px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:3.8rem;
  color:white;
  text-shadow: 0 3px 15px rgba(0,0,0,0.4);
  backdrop-filter: blur(8px); /* Increased blur for a glassier effect */
  background: rgba(0, 0, 0, 0.062); /* Slightly darker background */
  border: 1px solid rgba(255,255,255,0.1);
  opacity:0;
  transform:translate(-50%, -50%) scale(0.9);
  transition:opacity .14s ease, transform .14s ease, backdrop-filter .14s ease;
}
.countdown.show { opacity:1; transform:translate(-50%, -50%) scale(1); }

/* --------------------------------------------------
   Buttons & Filters
-------------------------------------------------- */
.filter-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

.controls-row { 
  margin-top: 6px; 
  display:flex; 
  gap:16px; 
  align-items:center; 
  justify-content:center; 
  width:100%; 
}

.capture-btn { 
  width:86px; 
  height:86px; 
  border-radius:999px; 
  background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9)); 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  box-shadow: 0 14px 40px rgba(162,89,193,0.12); 
  border: 6px solid rgba(162,89,193,0.18); 
  cursor:pointer; 
  transition: transform .12s, box-shadow .12s; 
}

.capture-btn .inner { 
  width:60px; 
  height:60px; 
  border-radius:999px; 
  background: var(--accent); 
  color:white; 
  font-weight:700; 
  font-size:1.1rem; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
}

/* Generic Buttons */
.btn {
  border-radius:10px;
  padding:10px 14px;
  border:1px solid rgba(74,47,90,0.06);
  cursor:pointer;
  font-weight:600;
  background:transparent;
  font-size:0.95rem;
}
.btn.filter-btn.selected {
  background: var(--accent);
  color: white;
}

/* Small preview thumbnails */
#stripPreview {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

/* --------------------------------------------------
   Side Panel
-------------------------------------------------- */
.side-panel {
  display: flex; 
  flex-direction: column;
  gap: 0; /* No gap needed as there's only one child */
  padding: 10px; /* Symmetrical padding */
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,248,252,0.94)); 
  border-radius: 18px; 
  border: 1px solid rgba(74,47,90,0.06); 
  box-shadow: 0 12px 30px rgba(44,31,62,0.06);
  align-items: center;
  flex-shrink: 0; /* Prevent side panel from shrinking */
  min-height: 0; /* Allow flex children to shrink if needed */
}

/* --------------------------------------------------
   Layout Options â€” NOT SCROLLABLE (Auto-Fit)
-------------------------------------------------- */
.layout-options {
  width: 100%;
  flex: 1;
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  padding: 0;
  overflow: visible;   /* FIXED: prevent selected card from getting cut */
}

/* Layout card (same original styling) */
.layout-card {
  width: 110px;
  margin: 0 auto;
  border-radius:14px;
  background: rgba(255,255,255,0.92); /* Slightly more transparent to match other elements */
  padding:10px 6px;
  box-shadow: 0 8px 22px rgba(44, 31, 62, 0.363);
  cursor:pointer;
  text-align:center;
  border: 3px solid transparent; 
  transition: 0.2s;
}

.layout-card.selected {
  border-color: var(--accent);
  transform: scale(1.04);
}

.layout-card img {
  width:100%;
  border-radius:10px;
  border:1px solid rgba(74,47,90,0.06);
}

.layout-card span {
  display:block;
  font-weight:600;
  font-size:0.85rem;
  margin-top:6px;
  color:var(--text-color);
}

/* --------------------------------------------------
   Tablet: 2 columns
-------------------------------------------------- */
@media(max-width: 1024px) {
  .layout-options {
    grid-template-columns: repeat(2, 1fr);
  }
}
@media(max-width: 600px) {
  .layout-card {
    width: 110px;
  }
}

/* Modal Overlay */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(4px);
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.modal-overlay.open {
  opacity: 1;
  visibility: visible;
}

/* Modal Content */
.modal-content {
  background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(214, 206, 206, 0.904));
  border-radius: 18px;
  padding: 20px;
  box-shadow: var(--shadow);
  
  max-width: 90vw;          /* Never wider than viewport */
  max-height: 90vh;         /* Never taller than viewport */
  
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;

  overflow-y: auto;          /* Scroll inside modal if content too tall */
  overflow-x: hidden;
  box-sizing: border-box;
  transform: scale(0.95);
  transition: transform 0.3s ease;
}

.modal-overlay.open .modal-content {
  transform: scale(1);
}

/* Modal Images */
#stripPreviewModal img {
  max-width: 100%;           /* Image fits modal width */
  max-height: 70vh;          /* Image never taller than 70% of viewport */
  width: auto;
  height: auto;
  border-radius: 6px;
  box-shadow: 0 8px 25px rgba(44, 31, 62, 0.15);
}

/* Modal Buttons */
.modal-content .btn.primary {
  background-color: var(--accent);
  color: white;
  border-color: var(--accent);
  padding: 10px 18px;
  border-radius: 12px;
  font-weight: 600;
  transition: all 0.2s ease;
}

.modal-content .btn.primary:hover {
  background-color: #924ab1;  /* Slightly darker on hover */
  border-color: #924ab1;
  box-shadow: 0 6px 16px rgba(162,89,193,0.2);
}

.modal-content .btn.ghost {
  background: transparent;
  color: var(--text-color);
  border: 1px solid rgba(74,47,90,0.1);
}

.modal-content .btn.ghost:hover {
  background: rgba(74,47,90,0.05);
}

/* Mobile adjustments */
@media (max-width: 600px) {
  .modal-content {
    width: 90vw;
    padding: 15px;
  }

  #stripPreviewModal img {
    max-height: 50vh;
  }
}

/* --------------------------------------------------
   RESPONSIVE FIXES
-------------------------------------------------- */
@media(max-width: 900px) {
  .app {
    grid-template-columns: 1fr;
  }
}

@media(max-width: 600px) {
  .app {
    margin: 70px 10px 30px 10px;
    padding: 14px;
  }

  .side-panel {
    width: 100%;
    order: 3;
  }

  .camera-frame {
    width: 100%;
    max-width: 100%;
  }

  .layout-options {
    flex-direction: row;
    overflow-x: auto;
    overflow-y: hidden;
    max-height: none;
  }

  .layout-card {
    flex: 0 0 100px;
  }
}

</style>
</head>
<body>

<button class="back-btn">â‹† Ëšï½¡Back â‹†ï½¡Â°</button>

<div class="app">
  <!-- CAMERA -->
  <div class="app-content" id="app">
    <section class="camera-shell">
      <div class="camera-frame">
        <div class="chip" id="camStatus">Initializingâ€¦</div>
        <div class="viewer">
          <video id="video" autoplay playsinline muted></video>
          <div class="countdown" id="countdown">3</div>
        </div>

        <div class="filter-controls" id="filterControls">
          <button class="btn small filter-btn selected" data-filter="none">None</button>
          <button class="btn small filter-btn" data-filter="grayscale(1)">B&W</button>
          <button class="btn small filter-btn" data-filter="sepia(1)">Sepia</button>
          <button class="btn small filter-btn" data-filter="saturate(2)">Vibrant</button>
          <button class="btn small filter-btn" data-filter="contrast(1.4) brightness(0.9)">Vintage</button>
        </div>

        <div id="stripPreview"></div>

        <div class="controls-row">
          <button class="capture-btn" id="takeBtn" disabled><span class="inner">ðŸ“¸</span></button>
        </div>
      </div>
    </section>

    <!-- SIDE PANEL -->
    <section class="side-panel">
      <div class="layout-options" id="layoutOptions"></div>
    </section>
  </div>
  
</div>

<!-- MODAL -->
<div class="modal-overlay" id="photoStripModal">
  <div class="modal-content">
    <h3>Your Photo Strip is Ready! âœ¨</h3>
    <div id="stripPreviewModal"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn primary" id="downloadBtn">Save Photo</button>
      <button class="btn ghost" id="closeModalBtn">Take another</button>
    </div>
  </div>
</div>

<canvas id="captureCanvas" style="display:none"></canvas>
<canvas id="stripCanvas" style="display:none"></canvas>
<audio id="shutterSound" src="sound effect/shutter.mp3" preload="auto"></audio>

<script>
/* JS unchanged except camera init fix */
const video = document.getElementById('video');
const captureCanvas = document.getElementById('captureCanvas');
const captureCtx = captureCanvas.getContext('2d');
const stripCanvas = document.getElementById('stripCanvas');
const stripCtx = stripCanvas.getContext('2d');
const takeBtn = document.getElementById('takeBtn');
const camStatus = document.getElementById('camStatus');
const countdownEl = document.getElementById('countdown');
const shutterSound = document.getElementById('shutterSound');
const layoutContainer = document.getElementById('layoutOptions');
const stripPreview = document.getElementById('stripPreview');

// Modal Elements
const photoStripModal = document.getElementById('photoStripModal');
const stripPreviewModal = document.getElementById('stripPreviewModal');
const downloadBtn = document.getElementById('downloadBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
const backBtn = document.querySelector('.back-btn');

let photos = [];
let currentLayout = { name:'2 images', poses:2 };
let isCapturing = false;
let currentFilter = 'none';

async function initCamera(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "user" },
        // --- START OF CHANGES FOR PORTRAIT ASPECT RATIO (3:4) ---
        // Request a 3:4 portrait aspect ratio (width/height = 0.75)
        aspectRatio: { ideal: 0.75 }, 
        width: { ideal: 960 }, 
        height: { ideal: 1280 }
        // --- END OF CHANGES ---
      },
      audio: false
    });

    video.srcObject = stream;
    camStatus.textContent='Ready';
    takeBtn.disabled = false;

  } catch(e) {
    console.log(e);
    camStatus.textContent='Camera blocked or unavailable';
    takeBtn.disabled = true;
  }

  selectLayout(layouts[2]); // Default: 4 images
}

function runCountdown(duration=3){
  return new Promise(resolve=>{
    let count=duration;
    countdownEl.textContent=count;
    countdownEl.classList.add('show');
    const timer = setInterval(()=>{
      count--;
      if(count>0) countdownEl.textContent=count;
      else{
        clearInterval(timer);
        shutterSound.currentTime = 0;
        shutterSound.play().catch(()=>{});
        takePhoto();
        countdownEl.classList.remove('show');
        resolve();
      }
    },1000);
  });
}

function takePhoto(){
  const w = video.videoWidth || 640;
  const h = video.videoHeight || 480;
  captureCanvas.width = w;
  captureCanvas.height = h;

  captureCtx.filter = currentFilter;

  // Flip horizontally for selfie
  captureCtx.setTransform(1,0,0,1,0,0);
  captureCtx.translate(w,0);
  captureCtx.scale(-1,1);
  captureCtx.drawImage(video,0,0,w,h);

  captureCtx.setTransform(1,0,0,1,0,0);
  captureCtx.filter = 'none';

  photos.push(captureCanvas.toDataURL('image/jpeg',0.92));
  renderPreview();
}

function renderPreview(){
  stripPreview.innerHTML = '';
  photos.forEach(src => {
    const img = document.createElement('img');
    img.src = src;
    img.style.width = '80px';
    img.style.borderRadius = '4px';
    stripPreview.appendChild(img);
  });

  if (photos.length === currentLayout.poses) {
    generateStripAndShowModal();
  }
}

const layouts = [
  {name:'2 images', poses:2, h: 1200, w: 750, gap: 50, padding: 50, type: 'single', imageSrc: 'choose a layout/2 images.png'},
  {name:'3 images', poses:3, h: 1800, w: 750, gap: 60, padding: 50, type: 'single', imageSrc: 'choose a layout/3 images.png'},
  {name:'4 images', poses:4, h: 2300, w: 750, gap: 50, padding: 50, type: 'single', imageSrc: 'choose a layout/4 images.png'},
  {name:'6 images', poses:6, h: 925, w: 725, gap: 30, padding: 30, type: 'grid_2x3', imageSrc: 'choose a layout/6 images.png'} 
];

function selectLayout(layout) {
  currentLayout = layout;
  photos = [];
  renderPreview();

  document.querySelectorAll('.layout-card').forEach(card => card.classList.remove('selected'));
  const selectedCard = document.querySelector(`.layout-card[data-layout-name="${layout.name}"]`);
  if(selectedCard) selectedCard.classList.add('selected');
}

layouts.forEach(l=>{
  const card=document.createElement('div'); 
  card.className='layout-card';
  card.setAttribute('data-layout-name', l.name);
  card.innerHTML=`<img src="${l.imageSrc}"><span>${l.name}</span>`;
  card.onclick=() => selectLayout(l);
  layoutContainer.appendChild(card);
});

async function generateStripAndShowModal() {
  const layout = currentLayout;
  const loadedImages = await Promise.all(
    photos.map(src => new Promise(res=>{
      const img = new Image();
      img.onload = () => res(img);
      img.src = src;
    }))
  );

  stripCanvas.width = layout.w;
  stripCanvas.height = layout.h;
  stripCtx.fillStyle = 'white';
  stripCtx.fillRect(0,0,layout.w,layout.h);

  let currentY = layout.padding;
  const stripInnerWidth = layout.w - (layout.padding * 2);
  const photoAspect = loadedImages[0].naturalHeight / loadedImages[0].naturalWidth;

  if (layout.type === 'single') {
    const stripPhotoHeight = stripInnerWidth * photoAspect;
    loadedImages.forEach((img, i)=>{
      stripCtx.drawImage(img, layout.padding, currentY, stripInnerWidth, stripPhotoHeight);
      currentY += stripPhotoHeight + (i < loadedImages.length - 1 ? layout.gap : 0);
    });
  }

  else if (layout.type === 'grid_2x3') {
    const cols = 2;
    const g = layout.gap;
    const photoWidth = (stripInnerWidth - g) / cols;
    const photoHeight = photoWidth * photoAspect;

    for (let i = 0; i < loadedImages.length; i += 2) {
      stripCtx.drawImage(loadedImages[i], layout.padding, currentY, photoWidth, photoHeight);
      if (loadedImages[i+1]) {
        stripCtx.drawImage(loadedImages[i+1], layout.padding + photoWidth + g, currentY, photoWidth, photoHeight);
      }
      currentY += photoHeight + g;
    }
  }

  const dataURL = stripCanvas.toDataURL('image/png');
  stripPreviewModal.innerHTML = `<img src="${dataURL}" style="max-width:100%;border-radius:6px;">`;
  photoStripModal.classList.add('open');
}

function downloadStrip() {
  const src = stripPreviewModal.querySelector('img').src;
  const a = document.createElement('a');
  a.href = src;
  a.download = `photobooth_strip_${currentLayout.name.replace(/[^a-z0-9]/gi,'_')}.png`;
  a.click();
}

function closeModal() {
  photoStripModal.classList.remove('open');
  selectLayout(currentLayout);
}

takeBtn.onclick = async ()=>{
  if(isCapturing || takeBtn.disabled) return;
  isCapturing = true;
  takeBtn.disabled = true;

  photos = [];
  renderPreview();
  closeModal();

  for(let i=0; i < currentLayout.poses; i++){
    await runCountdown(3);
    if(i < currentLayout.poses - 1) await new Promise(r=>setTimeout(r,500));
  }

  isCapturing = false;
  takeBtn.disabled = false;
};

document.getElementById('filterControls').addEventListener('click', (e)=>{
  if(e.target.classList.contains('filter-btn')){
    currentFilter = e.target.dataset.filter;
    video.style.filter = currentFilter;

    document.querySelectorAll('.filter-btn').forEach(btn=>btn.classList.remove('selected'));
    e.target.classList.add('selected');
  }
});

backBtn.onclick = () => window.location.href = 'letter.html';
downloadBtn.onclick = downloadStrip;
closeModalBtn.onclick = closeModal;

window.addEventListener('DOMContentLoaded', initCamera);
</script>
</body>
</html>